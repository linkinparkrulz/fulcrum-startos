"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupInit = setupInit;
const util_1 = require("../util");
function setupInit(...inits) {
    return async (opts) => {
        for (const idx in inits) {
            const init = inits[idx];
            const fn = async (effects, kind) => {
                let res = () => { };
                const complete = new Promise((resolve) => {
                    res = resolve;
                });
                const e = effects.child(`init_${idx}`);
                e.constRetry = (0, util_1.once)(() => complete.then(() => fn(effects, null)).catch(console.error));
                try {
                    if ("init" in init)
                        await init.init(e, kind);
                    else
                        await init(e, kind);
                }
                finally {
                    res();
                }
            };
            await fn(opts.effects, opts.kind);
        }
    };
}
//# sourceMappingURL=setupInit.js.map